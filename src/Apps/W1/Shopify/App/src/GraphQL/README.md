# GraphQL Cost Analysis and Update Scripts

This folder contains PowerShell scripts to analyze and update GraphQL query costs in the Shopify Connector codeunits.

## Overview

The Shopify GraphQL API assigns a cost to each query based on its complexity. These scripts help ensure that the `GetExpectedCost()` values in our codeunits match the actual costs calculated by Shopify.

## Scripts

### 1. Analyze-GraphQLCosts.ps1

Analyzes all GraphQL codeunits and compares their expected costs with actual costs from Shopify.

**Features:**
- Extracts GraphQL queries and expected costs from all codeunits
- Sends each query to Shopify to get the actual cost
- Generates a CSV report with comparisons
- Provides a summary of matches, underestimated, and overestimated costs

**Usage:**
```powershell
.\Analyze-GraphQLCosts.ps1 -ShopUrl "https://your-shop.myshopify.com" -AccessToken "shpat_xxxxx"
```

**Parameters:**
- `ShopUrl` (Required): Your Shopify shop URL
- `AccessToken` (Required): Shopify Admin API access token with GraphQL access
- `OutputCsv` (Optional): Output CSV file path (default: "graphql-costs-analysis.csv")

**Example:**
```powershell
.\Analyze-GraphQLCosts.ps1 `
    -ShopUrl "https://my-test-shop.myshopify.com" `
    -AccessToken "shpat_1234567890abcdef" `
    -OutputCsv "cost-analysis-2024.csv"
```

### 2. Update-GraphQLCosts.ps1

Updates the codeunits with actual costs from the CSV analysis file.

**Features:**
- Reads the CSV file generated by the analyze script
- Automatically updates `GetExpectedCost()` methods with correct values
- Creates backups before making any changes
- Skips files with errors or matches
- Provides detailed progress and summary

**Usage:**
```powershell
.\Update-GraphQLCosts.ps1 -CsvPath "graphql-costs-analysis.csv"
```

**Parameters:**
- `CsvPath` (Required): Path to the CSV file from the analyze script
- `BackupFolder` (Optional): Custom backup folder path (default: "Backup_<timestamp>")
- `Force` (Optional): Skip confirmation prompts

**Example:**
```powershell
# With confirmation prompt
.\Update-GraphQLCosts.ps1 -CsvPath "cost-analysis-2024.csv"

# Without confirmation prompt
.\Update-GraphQLCosts.ps1 -CsvPath "cost-analysis-2024.csv" -Force

# With custom backup folder
.\Update-GraphQLCosts.ps1 -CsvPath "cost-analysis-2024.csv" -BackupFolder "C:\Backups\GraphQL"
```

## Prerequisites

### Setting Up Shopify Access

1. **Get a Shopify Admin API Access Token:**
   - Go to your Shopify admin panel
   - Navigate to Settings → Apps and sales channels → Develop apps
   - Create a new app or select an existing one
   - Configure Admin API scopes (you'll need read access for your queries)
   - Install the app and get the Admin API access token

2. **Important Security Notes:**
   - Never commit access tokens to source control
   - Use environment variables or secure storage for tokens
   - Revoke tokens when no longer needed

### PowerShell Requirements

- PowerShell 5.1 or later (Windows PowerShell or PowerShell Core)
- Internet connectivity to reach Shopify API
- Appropriate file system permissions to read/write codeunit files

## Workflow

### Complete Update Process

1. **Prepare Your Environment**
   ```powershell
   # Navigate to the GraphQL folder
   cd "C:\depot\NAV\App\BCApps\src\Apps\W1\Shopify\App\src\GraphQL"
   ```

2. **Run the Analysis**
   ```powershell
   # TODO: Replace these values with your actual Shopify credentials
   $shopUrl = "https://YOUR-SHOP.myshopify.com"
   $token = "shpat_YOUR_ACCESS_TOKEN"
   
   .\Analyze-GraphQLCosts.ps1 -ShopUrl $shopUrl -AccessToken $token
   ```

3. **Review the Results**
   - Open the generated CSV file (default: `graphql-costs-analysis.csv`)
   - Review files marked as "Underestimated" or "Overestimated"
   - Check for any errors or queries that failed

4. **Update the Codeunits**
   ```powershell
   .\Update-GraphQLCosts.ps1 -CsvPath "graphql-costs-analysis.csv"
   ```

5. **Verify the Changes**
   - Review the updated files in your version control system
   - Check the backup folder for original versions
   - Build and test the application

6. **Commit the Changes**
   ```powershell
   git add Codeunits/*.al
   git commit -m "Update GraphQL query costs based on Shopify API analysis"
   ```

## CSV Output Format

The analysis script generates a CSV with the following columns:

| Column | Description |
|--------|-------------|
| FileName | Name of the codeunit file |
| ExpectedCost | Cost value currently in the file |
| ActualCost | Cost reported by Shopify API |
| Status | Match, Underestimated, Overestimated, or Error |
| Difference | Difference between actual and expected (ActualCost - ExpectedCost) |

**Status Values:**
- `Match`: Expected cost matches actual cost (no update needed)
- `Underestimated`: Expected cost is lower than actual (needs increase)
- `Overestimated`: Expected cost is higher than actual (can be decreased)
- `Query Not Found`: Could not extract query from the file
- `Query Failed`: Error calling Shopify API
- `Processing Error`: Error reading or parsing the file

## Troubleshooting

### Rate Limiting

If you encounter Shopify API rate limits:
- The analyze script includes a 500ms delay between requests
- For large numbers of files, consider running in batches
- Monitor the Shopify API rate limit headers

### Authentication Errors

If you get authentication errors:
- Verify your access token is correct
- Ensure the app has appropriate API scopes
- Check that the shop URL is correct (include `https://` and `.myshopify.com`)

### File Update Issues

If updates fail:
- Check file permissions
- Ensure files are not locked by another process (e.g., VS Code)
- Review the backup folder for original versions
- The update script will automatically restore from backup on failure

### Query Parameter Placeholders

Some queries contain placeholders like `{{CustomerId}}`, `{{Time}}`, etc. The analysis script **automatically replaces these with valid dummy values** before sending to Shopify:
- IDs: Valid Shopify GID format with dummy numeric values
- Dates: ISO 8601 formatted timestamps
- URLs: Example URLs in proper format
- Enums: Valid GraphQL enum values
- Text: Realistic test values

This ensures Shopify accepts the queries and returns accurate cost calculations.

## Notes

- **Backup Safety**: The update script always creates backups before modifying files
- **Dry Run**: Review the CSV before running updates to see what will change
- **Version Control**: Commit changes with clear messages for easy rollback
- **API Version**: Scripts use API version `2025-07` (matches the AL codeunit)
- **Rate Limits**: Analyze script includes delays to respect Shopify rate limits

## Maintenance

When updating to a new Shopify API version:
1. Update the `$ApiVersion` variable in `Analyze-GraphQLCosts.ps1`
2. Ensure it matches the version in `ShpfyCommunicationMgt.Codeunit.al`
3. Re-run the analysis to get updated costs

## Support

For issues or questions:
- Review script output for specific error messages
- Check Shopify API documentation for query cost details
- Verify AL codeunit structure hasn't changed significantly
